{
  "variables": {
    "aws_region": "ca-central-1"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "{{user `aws_region`}}",
      "source_ami": "ami-0533167fcff018a86",
      "instance_type": "t3.micro",
      "ssh_username": "ec2-user",
      "ami_name": "three-tier-frontend-{{timestamp}}",
      "ami_description": "Custom frontend AMI with nginx + git + Node.js 22 (Amazon Linux 2023, kernel 6.12)",
      "tags": {
        "Project": "three-tier",
        "Tier": "frontend"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
"inline": [
  "set -e",

  "echo 'ðŸ“¦ Updating system packages'",
  "sudo dnf update -y",

  "echo 'ðŸ“¦ Installing nginx and git'",
  "sudo dnf install -y nginx git",

  "sudo systemctl enable nginx",
  "sudo systemctl start nginx",

  "echo 'ðŸ“¦ Installing NVM (Node Version Manager)'",
  "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash",

  "export NVM_DIR=\"$HOME/.nvm\"",
  "[ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"",

  "echo 'ðŸ“¦ Installing Node.js v22 via NVM'",
  "nvm install 22",

  "echo 'ðŸ“¦ Verifying Node.js installation'",


  "echo 'âœ… Frontend AMI preparation complete!'"
]

    }
  ],
  "post-processors": [
    {
      "type": "manifest",
      "output": "manifest.json"
    }
  ]
}
